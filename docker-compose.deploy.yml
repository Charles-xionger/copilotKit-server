services:
  # CopilotKit Server æœåŠ¡ - ä½¿ç”¨é•œåƒéƒ¨ç½²
  copilot-server:
    image: copilot-server:latest # ğŸ”¥ ä½¿ç”¨æ„å»ºå¥½çš„é•œåƒ
    container_name: copilot-server
    restart: always
    ports:
      - "3001:3001"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-EmoCff32UUl3lQKxtqNheEp6T8kyRM8c9CJsML9DhWveDf3O}
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-https://api.chatgptsb.com/v1}
      - LANGGRAPH_URL=${LANGGRAPH_URL:-http://101.133.175.174:8123}
      - PORT=3001
      - NODE_ENV=production
    networks:
      - copilot-network
      - traefik_net # Traefik ç½‘ç»œ
    labels:
      #######################################################################
      # Traefik åå‘ä»£ç†æ ¸å¿ƒæ ‡ç­¾ï¼ˆåç«¯ API æœåŠ¡ï¼‰
      #######################################################################
      # 1. å…è®¸ Traefik ä»£ç†è¯¥æœåŠ¡
      - "traefik.enable=true"

      # 2. é…ç½® API è®¿é—®åŸŸåå’Œè·¯å¾„
      - "traefik.http.routers.copilot-api.rule=Host(`copilot.xiongerer.xyz`) && PathPrefix(`/copilotkit`)"

      # 3. ç»‘å®š Traefik çš„å…¥å£
      - "traefik.http.routers.copilot-api.entrypoints=websecure"

      # 4. å¯ç”¨ HTTPS è¯ä¹¦
      - "traefik.http.routers.copilot-api.tls=true"
      - "traefik.http.routers.copilot-api.tls.certresolver=letsencrypt"

      # 5. æŒ‡å‘å®¹å™¨å†…éƒ¨ç«¯å£
      - "traefik.http.services.copilot-api.loadbalancer.server.port=3001"

      # 6. CORS ä¸­é—´ä»¶ï¼ˆå…è®¸å‰ç«¯è·¨åŸŸè®¿é—®ï¼‰
      - "traefik.http.routers.copilot-api.middlewares=copilot-cors"
      - "traefik.http.middlewares.copilot-cors.headers.accesscontrolallowmethods=GET,POST,OPTIONS,PUT,DELETE"
      - "traefik.http.middlewares.copilot-cors.headers.accesscontrolalloworigin=*"
      - "traefik.http.middlewares.copilot-cors.headers.accesscontrolallowheaders=*"

      #######################################################################
      # HTTP è·³è½¬ HTTPS
      #######################################################################
      - "traefik.http.routers.copilot-api-http.rule=Host(`copilot.xiongerer.xyz`) && PathPrefix(`/copilotkit`)"
      - "traefik.http.routers.copilot-api-http.entrypoints=web"
      - "traefik.http.routers.copilot-api-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

networks:
  copilot-network:
    driver: bridge
  traefik_net:
    external: true
